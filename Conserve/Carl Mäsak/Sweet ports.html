http://strangelyconsistent.org/blog/sweet-ports
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name=viewport content="width=device-width, initial-scale=1">
    <title>Sweet ports :: Strangely Consistent</title>
    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link rel="alternate" title="Strangely Consistent atom feed" href="http://strangelyconsistent.org/blog/feed.atom" type="application/atom+xml">
    <link href='http://fonts.googleapis.com/css?family=OFL+Sorts+Mill+Goudy+TT:italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Molengo' rel='stylesheet' type='text/css'>
    <style type="text/css" media="all"> 
      @import "http://strangelyconsistent.org/blog/css/main.css";
    </style>
  </head>
  <body>
    <header>
      <hgroup>
        <h1><a href="/">Strangely Consistent</a></h1>
        <h2>Theory, practice, and languages, braided together</h2>
      </hgroup>
      <nav>
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/about">About</a></li>
          <li><a href="http://strangelyconsistent.org/blog/list-of-posts">Archive</a></li>
        </ul>
      </nav>
    </header>

    <article>
  <header>
    <div class="postinfo">
      <div><time datetime="2012-10-26T22:19:37+02:00" pubdate="pubdate">26 Oct, 2012</time></div>
      <div>by Carl MÃ¤sak</div>
      <div><a href="/no-comments">no notes</a></div>
    </div>
    <h1><a href="http://strangelyconsistent.org/blog/sweet-ports">Sweet ports</a></h1>
  </header>

  <p>I had invited jnthn over because I had invested in a bottle of nice port wine that I really wanted to try, but one whole bottle was too much for me. For both of us, during the course of an afternoon, it was about right.</p>

<p><img style="float: right; border: solid 1px black; margin: 1em" src="http://strangelyconsistent.org/blog/images/jnthn-porting.jpg" alt="jnthn holding a glass of port"></p>

<p>So that was the premise. Because we both like bad puns &mdash; jnthn admittedly more than I do &mdash; we decided to make it a "porting hackathon", where we would port some piece of software to Perl 6 while sipping the sweet beverage from Portugal.</p>

<p><strong>Which piece of software did we end up porting?</strong></p>

<p><a href="https://metacpan.org/module/JSON::Path"><code>JSON::Path</code></a> from CPAN. It's a module that does for JSON what XPath did for XML.</p>

<p>Well, actually <code>JSON::Path</code> is not very tied to the JSON format at all. It just expects your data to be a hierarchy of arrays, hashes, and scalar values, just like JSON.</p>

<p>Here are some JsonPath examples, just to give you a taste of it:</p>

<pre><code>$.class.student[0].name           name of first student in class hash
$['class']['student'][0]['name']  same, with an alternate notation
$.beers[*]                        all beers
$.beers[*].name                   names of all beers
$..author                         recursively find all 'author' entries
</code></pre>

<p>See <a href="http://goessner.net/articles/JsonPath/">here</a> for a more detailed specification.</p>

<p><strong>Any nice insights along the way?</strong></p>

<p>Yes, we found a pattern which we really liked. Not sure what it's called, or if it has a name. We're certainly not the first to come across it &mdash; it's probably well-known in FP circles. But as soon as we came up with the idea, the rest of the design basically fell into place.</p>

<p>Perhaps the easiest way to explain the pattern is to say this: our action methods make little subroutines.</p>

<pre><code>method command:sym&lt;.&gt;($/) {
    my $key = ~$&lt;ident&gt;;
    make sub ($next, $current, @path) {
        $next($current{$key}, [@path, "['$key']"]);
    }
}
</code></pre>

<p>This is especially apt, because the JsonPath language is all about how to find data in a hierarchical data structure. So each little subroutine outlines how one particular piece of syntax digs further down into the data structure. In the above case, it's saying that a JsonPath fragment such as</p>

<pre><code>.foo
</code></pre>

<p>will be translated to Perl 6 code such as</p>

<pre><code>$current{'foo'}
</code></pre>

<p>All the other action methods also return little anonymous subs like this one. To make it all work, the grammar is structured so that the fragments end up nesting around each other from left to right:</p>

<pre><code>token commandtree {
    &lt;command&gt; &lt;commandtree&gt;?
}
</code></pre>

<p>The resulting AST comes out looking like a Matryoshka doll of <code>commandtree</code> nodes. Or a chain where each link is generated by its own specific rule. The links of the chain are forged together by the <code>commandtree</code> action method, that uses <code>assuming</code> to pre-set the <code>$next</code> parameter of the anonymous functions:</p>

<pre><code>method commandtree($/) {
    make $&lt;command&gt;.ast.assuming(
        $&lt;commandtree&gt;
            ?? $&lt;commandtree&gt;[0].ast
            !! #`[create a function that returns the result];
}
</code></pre>

<p>And that's it. Long ago in the mists of computer history, AI researchers must have felt that intelligence would sprout from depths of LISP because they knew about patterns like this one: how to build up complex behavior by forging together little links in a chain, each one a simple "atom" of behavior. At least that's how it felt to see this experiment work.</p>

<p>It also made me <a href="http://twitter.com/carlmasak/status/259962045338902528">tweet this</a>:</p>

<p><img src="http://strangelyconsistent.org/blog/images/hop-tweet.png" alt="&quot;Whenever I use higher-order functions properly, it suddenly feels like I'm doing <em>real</em> coding, not some watered-down attempts at coding.&quot;" title=""></p>

<p><strong>Yes, but how was the port?</strong></p>

<p>Oh, it was pretty nifty. I've decided to provisionally like port wine after this. It's fruity and sweet, and goes really well with cheese, or quality chocolate.</p>

<p>Here's a picture of the finished bottle, along with all the tests passing:</p>

<p><img src="http://strangelyconsistent.org/blog/images/screenshot-and-bottle.jpg" alt="A picture of a screenshot and an empty bottle of port." title=""></p>

<p>Our finished module can be found <a href="https://github.com/jnthn/json-path">at Github</a>.</p>

</article>

  </body>
</html>
