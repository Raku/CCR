https://6guts.wordpress.com/2017/04/22/massively-reducing-moarvm-fixed-size-allocator-contention/
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>
Massively reducing MoarVM Fixed Size Allocator contention | 6guts</title>
<link rel="profile" href="https://gmpg.org/xfn/11" />
<link rel="stylesheet" type="text/css" media="all" href="https://s0.wp.com/wp-content/themes/pub/twentyten/style.css?ver=20190507" />
<link rel="pingback" href="https://6guts.wordpress.com/xmlrpc.php">
<link rel='dns-prefetch' href='//s0.wp.com' />
<link rel='dns-prefetch' href='//s.pubmine.com' />
<link rel='dns-prefetch' href='//x.bidswitch.net' />
<link rel='dns-prefetch' href='//static.criteo.net' />
<link rel='dns-prefetch' href='//ib.adnxs.com' />
<link rel='dns-prefetch' href='//aax.amazon-adsystem.com' />
<link rel='dns-prefetch' href='//bidder.criteo.com' />
<link rel='dns-prefetch' href='//cas.criteo.com' />
<link rel='dns-prefetch' href='//gum.criteo.com' />
<link rel='dns-prefetch' href='//ads.pubmatic.com' />
<link rel='dns-prefetch' href='//gads.pubmatic.com' />
<link rel='dns-prefetch' href='//tpc.googlesyndication.com' />
<link rel='dns-prefetch' href='//ad.doubleclick.net' />
<link rel='dns-prefetch' href='//googleads.g.doubleclick.net' />
<link rel='dns-prefetch' href='//www.googletagservices.com' />
<link rel='dns-prefetch' href='//cdn.switchadhub.com' />
<link rel='dns-prefetch' href='//delivery.g.switchadhub.com' />
<link rel='dns-prefetch' href='//delivery.swid.switchadhub.com' />
<link rel='dns-prefetch' href='//a.teads.tv' />
<link rel='dns-prefetch' href='//prebid.media.net' />
<link rel='dns-prefetch' href='//adserver-us.adtech.advertising.com' />
<link rel='dns-prefetch' href='//fastlane.rubiconproject.com' />
<link rel='dns-prefetch' href='//prebid-server.rubiconproject.com' />
<link rel='dns-prefetch' href='//hb-api.omnitagjs.com' />
<link rel='dns-prefetch' href='//mtrx.go.sonobi.com' />
<link rel='dns-prefetch' href='//apex.go.sonobi.com' />
<link rel='dns-prefetch' href='//u.openx.net' />
<link rel="alternate" type="application/rss+xml" title="6guts &raquo; Feed" href="https://6guts.wordpress.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="6guts &raquo; Comments Feed" href="https://6guts.wordpress.com/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="6guts &raquo; Massively reducing MoarVM Fixed Size Allocator&nbsp;contention Comments Feed" href="https://6guts.wordpress.com/2017/04/22/massively-reducing-moarvm-fixed-size-allocator-contention/feed/" />
	<script type="text/javascript">
		/* <![CDATA[ */
		function addLoadEvent(func) {
			var oldonload = window.onload;
			if (typeof window.onload != 'function') {
				window.onload = func;
			} else {
				window.onload = function () {
					oldonload();
					func();
				}
			}
		}
		/* ]]> */
	</script>
			<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/s0.wp.com\/wp-includes\/js\/wp-emoji-release.min.js?m=1612197847h&ver=5.6.1"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([55357,56424,8205,55356,57212],[55357,56424,8203,55356,57212])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='all-css-0-1' href='https://s0.wp.com/_static/??-eJytUstuwyAQ/KFiZKuplEPVbwGzpcS8BEss/30WorZurLo+9II87Mx6dlg+RzYGj+CRSxs0i7Zo4zOfQ1JCZa5tkMJ2Y85P/C8uzlRaqM6uw0bhyhc/gRUIisWQ8QHtyayZIPMLYBTjxBra0D+5uhCUkDRVEvDruTt3A5fFWFW9N71MIi0842LhH/rgB7gjfZpqNYZYQkGmk1GHrTy0SAKN1/kX+SrAOgLduyiwMhwoI8CSbY97sjmShkkZE+TM6HSmONbm3T7A/ZrHIr/X4Z7UQW6bgrV/7poySgNtDxSqhskAJTlzBBfrNh0IQ0NgZIuyC/4HYO9WmLS/v3X96VNzYq1gFb251/6lH079+fQ8XG7nkUW+?cssminify=yes' type='text/css' media='all' />
<style id='wp-block-library-inline-css'>
.has-text-align-justify {
	text-align:justify;
}
</style>
<style id='jetpack-global-styles-frontend-style-inline-css'>
:root { --font-headings: unset; --font-base: unset; --font-headings-default: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif; --font-base-default: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;}
</style>
<link rel='stylesheet' id='all-css-2-1' href='https://s0.wp.com/_static/??-eJxti8sKgCAQAH8oW6KHdoi+xcTUWF1pjX4/OnSIOg0DM3BmYSgVmwrEQ2Q8XEgMmbiIFXXYgb3eQ3IPa8Ncwf/FZIJGgeToLZ+peBstg+/AIS0a72COU9OPUg69atV2AWWKN+I=?cssminify=yes' type='text/css' media='all' />
<script id='jetpack_related-posts-js-extra'>
var related_posts_js_options = {"post_heading":"h4"};
</script>
<script id='wpcom-actionbar-placeholder-js-extra'>
var actionbardata = {"siteID":"14597269","siteName":"6guts","siteURL":"http:\/\/6guts.wordpress.com","icon":"<img alt='' src='https:\/\/s0.wp.com\/i\/logo\/wpcom-gray-white.png' class='avatar avatar-50' height='50' width='50' \/>","canManageOptions":"","canCustomizeSite":"","isFollowing":"","themeSlug":"pub\/twentyten","signupURL":"https:\/\/wordpress.com\/start\/","loginURL":"https:\/\/wordpress.com\/log-in?redirect_to=https%3A%2F%2F6guts.wordpress.com%2F2017%2F04%2F22%2Fmassively-reducing-moarvm-fixed-size-allocator-contention%2F&signup_flow=account","themeURL":"","xhrURL":"https:\/\/6guts.wordpress.com\/wp-admin\/admin-ajax.php","nonce":"73a4d0c81a","isSingular":"1","isFolded":"","isLoggedIn":"","isMobile":"","subscribeNonce":"<input type=\"hidden\" id=\"_wpnonce\" name=\"_wpnonce\" value=\"db0032352c\" \/>","referer":"https:\/\/6guts.wordpress.com\/2017\/04\/22\/massively-reducing-moarvm-fixed-size-allocator-contention\/","canFollow":"1","feedID":"913460","statusMessage":"","customizeLink":"https:\/\/6guts.wordpress.com\/wp-admin\/customize.php?url=https%3A%2F%2F6guts.wordpress.com%2F2017%2F04%2F22%2Fmassively-reducing-moarvm-fixed-size-allocator-contention%2F","postID":"476","shortlink":"https:\/\/wp.me\/pZfpP-7G","canEditPost":"","editLink":"https:\/\/wordpress.com\/post\/6guts.wordpress.com\/476","statsLink":"https:\/\/wordpress.com\/stats\/post\/476\/6guts.wordpress.com","i18n":{"view":"View site","follow":"Follow","following":"Following","edit":"Edit","login":"Log in","signup":"Sign up","customize":"Customize","report":"Report this content","themeInfo":"Get theme: Twenty Ten","shortlink":"Copy shortlink","copied":"Copied","followedText":"New posts from this site will now appear in your <a href=\"https:\/\/wordpress.com\/read\">Reader<\/a>","foldBar":"Collapse this bar","unfoldBar":"Expand this bar","editSubs":"Manage subscriptions","viewReader":"View site in Reader","viewReadPost":"View post in Reader","subscribe":"Sign me up","enterEmail":"Enter your email address","followers":"Join 59 other followers","alreadyUser":"Already have a WordPress.com account? <a href=\"https:\/\/wordpress.com\/log-in?redirect_to=https%3A%2F%2F6guts.wordpress.com%2F2017%2F04%2F22%2Fmassively-reducing-moarvm-fixed-size-allocator-contention%2F&signup_flow=account\">Log in now.<\/a>","stats":"Stats"}};
</script>
<script type='text/javascript' src='https://s0.wp.com/_static/??-eJyFzdEKwjAMBdAfMiurMPFB/Ja5xZLSpLVpEP9+HSiILz6FezmXuGeBJUtDaS6q43yjhGCKdQ69A5J7HqIeXHckS7IVdYfxYVhf7zMwyV8ETKHODb/x5zMblGSBRF3F1NEKJWv7SX115cs4jf548ufJxw1oVkW8'></script>
<link rel='stylesheet' id='all-css-0-2' href='https://s0.wp.com/wp-content/mu-plugins/highlander-comments/style.css?m=1530132353h&cssminify=yes' type='text/css' media='all' />
<!--[if lt IE 8]>
<link rel='stylesheet' id='highlander-comments-ie7-css'  href='https://s0.wp.com/wp-content/mu-plugins/highlander-comments/style-ie7.css?m=1351637563h&#038;ver=20110606' media='all' />
<![endif]-->
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://6guts.wordpress.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://s0.wp.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress.com" />
<link rel="canonical" href="https://6guts.wordpress.com/2017/04/22/massively-reducing-moarvm-fixed-size-allocator-contention/" />
<link rel='shortlink' href='https://wp.me/pZfpP-7G' />
<link rel="alternate" type="application/json+oembed" href="https://public-api.wordpress.com/oembed/?format=json&amp;url=https%3A%2F%2F6guts.wordpress.com%2F2017%2F04%2F22%2Fmassively-reducing-moarvm-fixed-size-allocator-contention%2F&amp;for=wpcom-auto-discovery" /><link rel="alternate" type="application/xml+oembed" href="https://public-api.wordpress.com/oembed/?format=xml&amp;url=https%3A%2F%2F6guts.wordpress.com%2F2017%2F04%2F22%2Fmassively-reducing-moarvm-fixed-size-allocator-contention%2F&amp;for=wpcom-auto-discovery" />
<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="Massively reducing MoarVM Fixed Size Allocator contention" />
<meta property="og:url" content="https://6guts.wordpress.com/2017/04/22/massively-reducing-moarvm-fixed-size-allocator-contention/" />
<meta property="og:description" content="The latest MoarVM release, 2017.04, contains a significant improvement for multi-threaded applications, especially those that are CPU-bound. I mentioned the improvement briefly on Twitter, because …" />
<meta property="article:published_time" content="2017-04-22T14:37:35+00:00" />
<meta property="article:modified_time" content="2017-04-22T19:13:35+00:00" />
<meta property="og:site_name" content="6guts" />
<meta property="og:image" content="https://s0.wp.com/i/blank.jpg" />
<meta property="og:locale" content="en_US" />
<meta name="twitter:site" content="@wordpressdotcom" />
<meta name="twitter:text:title" content="Massively reducing MoarVM Fixed Size Allocator&nbsp;contention" />
<meta name="twitter:card" content="summary" />
<meta property="fb:app_id" content="249643311490" />
<meta property="article:publisher" content="https://www.facebook.com/WordPresscom" />

<!-- End Jetpack Open Graph Tags -->
<link rel="shortcut icon" type="image/x-icon" href="https://s0.wp.com/i/favicon.ico" sizes="16x16 24x24 32x32 48x48" />
<link rel="icon" type="image/x-icon" href="https://s0.wp.com/i/favicon.ico" sizes="16x16 24x24 32x32 48x48" />
<link rel="apple-touch-icon" href="https://s0.wp.com/i/webclip.png" />
<link rel='openid.server' href='https://6guts.wordpress.com/?openidserver=1' />
<link rel='openid.delegate' href='https://6guts.wordpress.com/' />
<link rel="search" type="application/opensearchdescription+xml" href="https://6guts.wordpress.com/osd.xml" title="6guts" />
<link rel="search" type="application/opensearchdescription+xml" href="https://s1.wp.com/opensearch.xml" title="WordPress.com" />
		<style type="text/css">
			.recentcomments a {
				display: inline !important;
				padding: 0 !important;
				margin: 0 !important;
			}

			table.recentcommentsavatartop img.avatar, table.recentcommentsavatarend img.avatar {
				border: 0px;
				margin: 0;
			}

			table.recentcommentsavatartop a, table.recentcommentsavatarend a {
				border: 0px !important;
				background-color: transparent !important;
			}

			td.recentcommentsavatarend, td.recentcommentsavatartop {
				padding: 0px 0px 1px 0px;
				margin: 0px;
			}

			td.recentcommentstextend {
				border: none !important;
				padding: 0px 0px 2px 10px;
			}

			.rtl td.recentcommentstextend {
				padding: 0px 10px 2px 0px;
			}

			td.recentcommentstexttop {
				border: none;
				padding: 0px 0px 0px 10px;
			}

			.rtl td.recentcommentstexttop {
				padding: 0px 10px 0px 0px;
			}
		</style>
		<meta name="application-name" content="6guts" /><meta name="msapplication-window" content="width=device-width;height=device-height" /><meta name="msapplication-tooltip" content="Tales of Perl 6 guts hacking" /><meta name="msapplication-task" content="name=Subscribe;action-uri=https://6guts.wordpress.com/feed/;icon-uri=https://s0.wp.com/i/favicon.ico" /><meta name="msapplication-task" content="name=Sign up for a free blog;action-uri=http://wordpress.com/signup/;icon-uri=https://s0.wp.com/i/favicon.ico" /><meta name="msapplication-task" content="name=WordPress.com Support;action-uri=http://support.wordpress.com/;icon-uri=https://s0.wp.com/i/favicon.ico" /><meta name="msapplication-task" content="name=WordPress.com Forums;action-uri=http://forums.wordpress.com/;icon-uri=https://s0.wp.com/i/favicon.ico" /><meta name="description" content="The latest MoarVM release, 2017.04, contains a significant improvement for multi-threaded applications, especially those that are CPU-bound. I mentioned the improvement briefly on Twitter, because it&#039;s hard to be anything other than brief on Twitter. This post contains a decidedly less brief, though hopefully somewhat interesting, description of what I did. Oh, and also a&hellip;" />
		<script type="text/javascript">

			window.doNotSellCallback = function() {

				var linkElements = [
					'a[href="https://wordpress.com/?ref=footer_blog"]',
					'a[href="https://wordpress.com/?ref=footer_website"]',
					'a[href="https://wordpress.com/?ref=vertical_footer"]',
					'a[href^="https://wordpress.com/?ref=footer_segment_"]',
				].join(',');

				var dnsLink = document.createElement( 'a' );
				dnsLink.href = 'https://wordpress.com/advertising-program-optout';
				dnsLink.classList.add( 'do-not-sell-link' );
				dnsLink.rel = 'nofollow';
				dnsLink.style.marginLeft = '0.5em';
				dnsLink.textContent = 'Do Not Sell My Personal Information';

				var creditLinks = document.querySelectorAll( linkElements );

				if ( 0 === creditLinks.length ) {
					return false;
				}

				Array.prototype.forEach.call( creditLinks, function( el ) {
					el.insertAdjacentElement( 'afterend', dnsLink );
				});

				return true;
			};

		</script>
				<script type="text/javascript">
		function __ATA_CC() {var v = document.cookie.match('(^|;) ?personalized-ads-consent=([^;]*)(;|$)');return v ? 1 : 0;}
		var __ATA_PP = { pt: 1, ht: 0, tn: 'twentyten', amp: false, siteid: 8982, blogid: 14597269, consent: __ATA_CC()   };
		var __ATA = __ATA || {};
		__ATA.cmd = __ATA.cmd || [];
		__ATA.criteo = __ATA.criteo || {};
		__ATA.criteo.cmd = __ATA.criteo.cmd || [];
		
		</script>
		<script type="text/javascript">
		(function(){var g=Date.now||function(){return+new Date};function h(a,b){a:{for(var c=a.length,d="string"==typeof a?a.split(""):a,e=0;e<c;e++)if(e in d&&b.call(void 0,d[e],e,a)){b=e;break a}b=-1}return 0>b?null:"string"==typeof a?a.charAt(b):a[b]};function k(a,b,c){c=null!=c?"="+encodeURIComponent(String(c)):"";if(b+=c){c=a.indexOf("#");0>c&&(c=a.length);var d=a.indexOf("?");if(0>d||d>c){d=c;var e=""}else e=a.substring(d+1,c);a=[a.substr(0,d),e,a.substr(c)];c=a[1];a[1]=b?c?c+"&"+b:b:c;a=a[0]+(a[1]?"?"+a[1]:"")+a[2]}return a};var l=0;function m(a,b){var c=document.createElement("script");c.src=a;c.onload=function(){b&&b(void 0)};c.onerror=function(){b&&b("error")};a=document.getElementsByTagName("head");var d;a&&0!==a.length?d=a[0]:d=document.documentElement;d.appendChild(c)}function n(a){var b=void 0===b?document.cookie:b;return(b=h(b.split("; "),function(c){return-1!=c.indexOf(a+"=")}))?b.split("=")[1]:""}function p(a){return"string"==typeof a&&0<a.length}
		function r(a,b,c){b=void 0===b?"":b;c=void 0===c?".":c;var d=[];Object.keys(a).forEach(function(e){var f=a[e],q=typeof f;"object"==q&&null!=f||"function"==q?d.push(r(f,b+e+c)):null!==f&&void 0!==f&&(e=encodeURIComponent(b+e),d.push(e+"="+encodeURIComponent(f)))});return d.filter(p).join("&")}function t(a,b){a||((window.__ATA||{}).config=b.c,m(b.url))}var u=Math.floor(1E13*Math.random()),v=window.__ATA||{};window.__ATA=v;window.__ATA.cmd=v.cmd||[];v.rid=u;v.createdAt=g();var w=window.__ATA||{},x="s.pubmine.com";
		w&&w.serverDomain&&(x=w.serverDomain);var y="//"+x+"/conf",z=window.top===window,A=window.__ATA_PP&&window.__ATA_PP.gdpr_applies,B="boolean"===typeof A?Number(A):null,C=window.__ATA_PP||null,D=z?document.referrer?document.referrer:null:null,E=z?window.location.href:document.referrer?document.referrer:null,F,G=n("__ATA_tuuid");F=G?G:null;var H=window.innerWidth+"x"+window.innerHeight,I=n("usprivacy"),J=r({gdpr:B,pp:C,rid:u,src:D,ref:E,tuuid:F,vp:H,us_privacy:I?I:null},"",".");
		(function(a){var b=void 0===b?"cb":b;l++;var c="callback__"+g().toString(36)+"_"+l.toString(36);a=k(a,b,c);window[c]=function(d){t(void 0,d)};m(a,function(d){d&&t(d)})})(y+"?"+J);}).call(this);
		</script><link rel="amphtml" href="https://6guts.wordpress.com/2017/04/22/massively-reducing-moarvm-fixed-size-allocator-contention/amp/"><script type="text/javascript">
	window.google_analytics_uacct = "UA-52447-2";
</script>

<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-52447-2']);
	_gaq.push(['_gat._anonymizeIp']);
	_gaq.push(['_setDomainName', 'wordpress.com']);
	_gaq.push(['_initData']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
	})();
</script>
</head>

<body class="post-template-default single single-post postid-476 single-format-standard customizer-styles-applied single-author highlander-enabled highlander-light">
<div id="wrapper" class="hfeed">
	<div id="header">
		<div id="masthead">
			<div id="branding" role="banner">
								<div id="site-title">
					<span>
						<a href="https://6guts.wordpress.com/" title="6guts" rel="home">6guts</a>
					</span>
				</div>
				<div id="site-description">Tales of Perl 6 guts hacking</div>

									<a class="home-link" href="https://6guts.wordpress.com/" title="6guts" rel="home">
						<img src="https://6guts.files.wordpress.com/2010/07/cropped-30141.jpg" width="940" height="198" alt="" />
					</a>
								</div><!-- #branding -->

			<div id="access" role="navigation">
								<div class="skip-link screen-reader-text"><a href="#content" title="Skip to content">Skip to content</a></div>
				<div class="menu"><ul>
<li ><a href="https://6guts.wordpress.com/">Home</a></li><li class="page_item page-item-2"><a href="https://6guts.wordpress.com/about/">About</a></li>
<li class="page_item page-item-24"><a href="https://6guts.wordpress.com/interesting-papers/">Interesting Papers</a></li>
</ul></div>
			</div><!-- #access -->
		</div><!-- #masthead -->
	</div><!-- #header -->

	<div id="main">

		<div id="container">
			<div id="content" role="main">

			

				<div id="nav-above" class="navigation">
					<div class="nav-previous"><a href="https://6guts.wordpress.com/2017/03/16/considering-hyperrace-semantics/" rel="prev"><span class="meta-nav">&larr;</span> Considering hyper/race semantics</a></div>
					<div class="nav-next"><a href="https://6guts.wordpress.com/2017/05/12/looking-for-perl-6-rakudo-and-moarvm-development-funding/" rel="next">Looking for Perl 6, Rakudo, and MoarVM development&nbsp;funding <span class="meta-nav">&rarr;</span></a></div>
				</div><!-- #nav-above -->

				<div id="post-476" class="post-476 post type-post status-publish format-standard hentry category-uncategorized">
											<h2 class="entry-title"><a href="https://6guts.wordpress.com/2017/04/22/massively-reducing-moarvm-fixed-size-allocator-contention/" rel="bookmark">Massively reducing MoarVM Fixed Size Allocator&nbsp;contention</a></h2>					
					<div class="entry-meta">
						<span class="meta-prep meta-prep-author">Posted on</span> <a href="https://6guts.wordpress.com/2017/04/22/massively-reducing-moarvm-fixed-size-allocator-contention/" title="3:37 PM" rel="bookmark"><span class="entry-date">April 22, 2017</span></a> <span class="meta-sep">by</span> <span class="author vcard"><a class="url fn n" href="https://6guts.wordpress.com/author/jnthnwrthngtn/" title="View all posts by jnthnwrthngtn">jnthnwrthngtn</a></span>					</div><!-- .entry-meta -->

					<div class="entry-content">
						<p>The latest MoarVM release, 2017.04, contains a significant improvement for multi-threaded applications, especially those that are CPU-bound. I mentioned the improvement briefly on Twitter, because it&#8217;s hard to be anything other than brief on Twitter. This post contains a decidedly less brief, though hopefully somewhat interesting, description of what I did. Oh, and also a bonus footnote in which I attempt to prove the safety (or lack of safety) of a couple of lock free algorithms, because that&#8217;s fun, right?</p>
<h3><a id="user-content-the-fixed-size-allocator" class="anchor" href="https://gist.github.com/jnthn/7c54bcfdf3c39603baa1c76851ddd11b#the-fixed-size-allocator"></a>The Fixed Size Allocator</h3>
<p>The most obvious way to allocate memory in a C program is through functions like <code>malloc</code> and <code>calloc</code>. Indeed, we do this plenty in MoarVM. The <code>malloc</code> and <code>calloc</code> implementations in C libraries have certainly been tuned a bunch, but at the same time they have to have good behavior for a very wide range of programs. They also need to keep track of the sizes of allocations, since a call to <code>free</code> does not pass the size of the memory being released. And they need to try to avoid fragmentation, which can lead to out-of-memory errors occurring because the heap ends up with lots of small gaps, but none big enough to allocate a larger object.</p>
<p>When we know a few more properties of the memory usage of a program, and we have information around to know the size of the memory block we are freeing, it&#8217;s possible to do a little better. MoarVM does this in multiple ways.</p>
<p>One of them is by using a bump-the-pointer allocator for memory that is managed by the garbage collector. These have a header that points to a type table that knows the size of the object that was allocated, meaning the size information is readily available. And the GC can move objects around in memory, since it can find all of the references to an object and update them, meaning there is a way out of the fragmentation trap too.</p>
<p>The call stack is another example. In the absence of closures, it is possible to allocate a block of memory and use it like a stack. When a program makes a call, the current location in the memory block is taken as the address for the call frame memory, and the location is bumped by the frame size. This could be seen as a &#8220;push&#8221;, in stack terms. Because call frames are left in the opposite order to which they are entered, freeing them is just subtraction. This could be seen as a &#8220;pop&#8221;. Since holes are impossible, fragmentation cannot occur.</p>
<p>A third case is covered by the fixed size allocator. This is the most difficult of the three. It tries to do a better job than <code>malloc </code>and friends in the case that, at the point when memory is freed, we readily know the size of the memory. This allows it to create regions of memory that consist of N blocks of a fixed size, and allocate the memory out of those regions (which it calls &#8220;pages&#8221;). When a memory request comes in, the allocator first checks if it&#8217;s within the size range that the fixed size allocator is willing to handle. If it isn&#8217;t, it&#8217;s passed along to <code>malloc</code>. Otherwise, the size is rounded up to the nearest &#8220;bin size&#8221; (which are 8 bytes, 16 bytes, 24 bytes, and so forth). A given bin consists of:</p>
<ul>
<li>1 or more pages, each with space for a certain number of allocations of the bin size</li>
<li>A free list of available memory locations of that size, which is maintained as a linked list (that is, each location contains a pointer to the next free location, with a NULL marking the end)</li>
</ul>
<p>If the free list contains any entries, then one of them will be taken. If not, then the pages will be considered. If the current page is not full, then the allocation will be made from it. Otherwise, another page will be allocated. When memory is freed, it is always added to the free list of the appropriate bin. Therefore, a longer-running program, in steady state, will typically end up getting all of its allocations from the free list.</p>
<h3><a id="user-content-enter-threads" class="anchor" href="https://gist.github.com/jnthn/7c54bcfdf3c39603baa1c76851ddd11b#enter-threads"></a>Enter threads</h3>
<p>Building a fixed size allocator for a single-threaded environment isn&#8217;t all that difficult. But what happens when it needs to cope with being used in a multi-threaded program? Well&#8230;it&#8217;s complicated. Clearly, it is not possible to have a single global fixed size allocator and have all of the threads just use it without any kind of concurrency control. Taking an item off the freelist is a multi-step process, and allocating from a page &#8211; or allocating a new page &#8211; is even more steps. Without concurrency control, there will be data races all over, and we&#8217;ll be handed a SIGSEGV in record time.</p>
<p>It&#8217;s worth stopping to consider what would happen if we were to give every thread its own fixed size allocator. This turns out to get messy fast, as memory allocated on one thread may be freed by another. A seemingly simple scheme is to say that the freed memory is simply appended to the freelist of the freeing thread&#8217;s fixed size allocator. Unfortunately, this has two bad properties.</p>
<ol>
<li>When the thread ends, we can&#8217;t just throw aways the pages &#8211; because bits of them may still be in use by other threads, or referenced in the free lists of other threads. So they&#8217;d need to be somehow &#8220;re-homed&#8221;, which is going to need some kind of coordination. Further measures may be needed to mitigate memory fragmentation in programs that spawn and join many threads during their lifetimes.</li>
<li>Imagine a producer/consumer setup, where one thread does allocations and passes the allocated memory to another thread, which processes the data in the memory and frees it. The producing thread will build up a lot of pages to allocate out of. The consuming thread will build up an ever longer free list. Memory runs out. D&#8217;oh.</li>
</ol>
<p>So, MoarVM went with a single global fixed size allocator. Of course, this has the drawback of needing concurrency control.</p>
<h3><a id="user-content-concurrency-control" class="anchor" href="https://gist.github.com/jnthn/7c54bcfdf3c39603baa1c76851ddd11b#concurrency-control"></a>Concurrency control</h3>
<p>The easiest possible form of concurrency control is to have threads acquire a mutex on every allocate and free operation. This has the benefit of being very straightforward to understand and reason about. It has the disadvantage of being extremely costly. Mutex acquisition can be relatively cheap, but it gets expensive when there is high contention &#8211; that is, lots of threads trying to obtain the lock. And since all CPU-bound threads will typically allocate some working memory, particularly in a VM for a dynamic language that doesn&#8217;t yet do escape analysis, that adds up to a <em>lot</em> of contention.</p>
<p>So, MoarVM did something more sophisticated.</p>
<p>First, the easy part. It&#8217;s possible to append to a free list with a CPU-provided atomic operation, provided taking from the freelist is also using one. So, no mutex acquisition is required for freeing memory. However, an atomic operation still requires a kind of locking down at the CPU level. It&#8217;s cheaper than a mutex acquire/release for sure, but there will still be contention between CPU cores for the cache line holding the head of the free list.</p>
<p>What about allocation? It turns out that we can <em>not</em> just take from a free list using an atomic operation without hitting the <a href="https://en.wikipedia.org/wiki/ABA_problem">ABA problem</a> (gory details in footnote). Therefore, some kind of locking is needed to ensure an ordering on the operations. In most cases, the atomic operation will work on the first attempt (it&#8217;s competing with frees, which happen without any kind of locking, meaning a retry will sometimes be needed). In cases where something will complete very rapidly, a <a href="https://en.wikipedia.org/wiki/Spinlock">spinlock</a> may be used in place of a full-on mutex. So, the MoarVM fixed size allocator allocation scheme boiled down to:</p>
<ol>
<li>Acquire the spin lock.</li>
<li>Try to take from the free list in a loop, until either we succeed or the free list is seen to be empty.</li>
<li>Release the spin lock.</li>
<li>If we failed to obtain memory from the free list, take the slow path to get memory from a page, allocating another page if needed. This slow path does acquire a real mutex.</li>
</ol>
<h3><a id="user-content-contention" class="anchor" href="https://gist.github.com/jnthn/7c54bcfdf3c39603baa1c76851ddd11b#contention"></a>Contention</h3>
<p>First up, I&#8217;ll note that the strategy outlined above <em>does</em> beat the &#8220;just take a mutex for every allocate/free&#8221; approach &#8211; at least, in all of the benchmarks I&#8217;ve considered. Frees end up being lock free, and most of the allocations just do a spin lock and an atomic operation.</p>
<p>At the same time, <strong>contention means contention</strong>, and no lock free data structure or spinlock changes that. If multiple threads are constantly scrambling to work on the same memory location &#8211; such as the head of a free list &#8211; it&#8217;s going to get expensive. How expensive? On an Intel Core i7, obtaining a cache line that is held by another core exclusively &#8211; which it typically will be under contention &#8211; costs somewhere around 70 CPU cycles. It gets worse in a multi-CPU setup, where it could easily be hundreds of CPU cycles. Note this is just for one operation; the spinlock is a further atomic operation and, of course, it uses some cycles as it spins.</p>
<p>But how much could this end up costing in a real world Perl 6 application? I recently had chance to find out, and the numbers were <em>ugly</em>. Measurements obtained by <code>perf</code> showed that a stunning <strong>40%</strong> of the application&#8217;s runtime was spent inside of the fixed size allocator. (Side note: <code>perf</code> is a sampling profiler, which &#8211; in my handwavey understanding &#8211; snapshots the callstack at regular intervals to figure out where time is being spent. My experience has been that sampling profilers tend to be better at showing up surprising costs like this than instrumenting profilers are, even if they are in some senses less precise.)</p>
<h3><a id="user-content-making-things-better" class="anchor" href="https://gist.github.com/jnthn/7c54bcfdf3c39603baa1c76851ddd11b#making-things-better"></a>Making things better</h3>
<p>Clearly, there was significant room for improvement. And, happily, things are now muchly improved and my real-world program did get something close to a 40% performance boost.</p>
<p>To make things better, I introduced per-thread freelists, while leaving pages global and retaining global free lists also.</p>
<p>Memory is allocated in the first place from global pages, as before. However, when it is freed, it is instead placed on a per-thread free list (with one free list per thread per size bin). When a thread needs memory, it first checks its thread-local free list to see if there is anything there. It will only then look at the global free list, or the global pages, if the thread-local free list cannot satisfy the memory request. The upshot of this is that the vast majority of allocations and frees performed by the fixed size allocator no longer have any contention.</p>
<p>However, as I mentioned earlier, one needs to be very careful when introducing things like thread-local freelists to not create bad behavior when a thread terminates or in producer/consumer scenarios. Therefore:</p>
<ul>
<li>When a thread termiantes, it will donate all the locations on its free list back to the global free list. Since pages are entirely global, there isn&#8217;t a fragmentation issue.</li>
<li>When a thread&#8217;s local free list for a particular size hits a limit, it will instead start to free to the global free list, which prevents unbounded free list growth in producer/consumer style programs.</li>
</ul>
<p>So, I believe this improvement is both good for performance without being badly behaved for any cases that previously would have worked out fine.</p>
<h3><a id="user-content-can-we-do-better" class="anchor" href="https://gist.github.com/jnthn/7c54bcfdf3c39603baa1c76851ddd11b#can-we-do-better"></a>Can we do better?</h3>
<p>Always! While the major contention bottleneck is gone, there are further opportunities for improvement that are worth exploring in the future.</p>
<ul>
<li>It would probably make sense to donate a bunch of free list entries to the global free list, rather than donating them individually. This would mean the contention of doing so only happened every N entries, not every entry, for the producer/consumer case. This is a fairly easy fix. (Homework, anyone? :-))</li>
<li>The current scheme is vulnerable to false sharing. The strategy of packing allocations of the same size together in pages is, in a single-threaded program, typically good for the CPU cache. But in a multi-threaded program, we can end up placing allocations that individual threads use next to each other. This means they may end up on the same cache line (the 32-byte or 64-byte memory regions that CPU caches hold). This is a harder nut to crack.</li>
</ul>
<h3><a id="user-content-in-summary" class="anchor" href="https://gist.github.com/jnthn/7c54bcfdf3c39603baa1c76851ddd11b#in-summary"></a>In summary&#8230;</h3>
<p>If you have CPU-bound multi-threaded Perl 6 programs, MoarVM 2017.04 could offer a big performance improvement. For my case, it was close to 40%. And the design lesson from this: on modern hardware, contention is really costly, and using a lock free data structure or picking the &#8220;best kind of lock&#8221; will not overcome that.</p>
<hr />
<p><strong>Footnote on the ABA vulnerability:</strong> It&#8217;s decidedly interesting &#8211; at least to me &#8211; that prepending to a free list can be safely done with a single atomic operation, but taking from it cannot be. Here I&#8217;ll attempt to provide a proof for these claims.</p>
<p>We&#8217;ll consider a single free list whose head lives at memory location <code>F</code>, and two threads, <code>T1</code> and <code>T2</code>. We assume the existence of an atomic operation, <code>TRY-CAS(location, old, new)</code>, which will &#8211; in a single CPU instruction that may not be interrupted &#8211; compare the value in memory pointed to by <code>location</code> with <code>old</code> and, if they match, replace it with <code>new</code>. (CAS is short for Compare And Swap.) The <code>TRY-CAS</code> function evaluates to <code>true</code> if the replacement took place, and <code>false</code> if not. The threads may be preempted (that is, taken off the CPU) at any point in time.</p>
<p>To show that allocation is vulnerable to the ABA problem, we just need to find an execution where it happens. First of all, we&#8217;ll define the operation <code>ALLOCATE</code> as:</p>
<pre><code>1: do
2:     allocated = *F
3:     if allocated != NULL
4:         next = allocated.next    
5: while allocated != NULL &amp;&amp; !TRY-CAS(F, allocated, next)
6: return allocated
</code></pre>
<p>And <code>FREE(C)</code> as:</p>
<pre><code>1: do
2:     current = *F
3:     C.next = current;
4: while !TRY-CAS(F, current, C)
</code></pre>
<p>Let&#8217;s consider a case where we have 3 memory cells, <code>C1</code>, <code>C2</code>, and <code>C3</code>. The free list head <code>F</code> points to <code>C1</code>, which in turn points to <code>C2</code>, which in turn points to <code>C3</code>.</p>
<p>Thread <code>T1</code> enters <code>ALLOCATE</code>, but is preempted immediately after the execution of line 4. At this point, <code>allocated</code> contains <code>C1</code> and <code>next</code> contains <code>C2</code>.</p>
<p>Next, <code>T2</code> calls <code>ALLOCATE</code>, and succeeds in making an allocation. <code>F</code> now points to <code>C2</code>. It again calls <code>ALLOCATE</code>, meaning that <code>F</code> now points to <code>C3</code>. It then calls <code>FREE(C1)</code>. At this point, <code>F</code> points to <code>C1</code> again, and <code>C1</code> points to <code>C3</code>. Notice that at this point, cell <code>C2</code> is considered to be allocated and in use.</p>
<p>Consider what happens if <code>T1</code> is resumed. It performs <code>TRY-CAS(F, C1, C2)</code>. This operation will succeed, because <code>F</code> does indeed currently point to <code>C1</code>. This means that <code>F</code> now come to point to <code>C2</code>. However, we earlier stated that <code>C2</code> is allocated and in use, and therefore should not be in the free list. Therefore we have demonstrated the code to be buggy, and shown how the bug arises as a result of the ABA problem.</p>
<p>What of the claim that the <code>FREE(C)</code> is not vulnerable to the ABA problem? To be vulnerable to the ABA problem, another thread must be able to change the state of something that the correctness of the operation depends upon, but that is <em>not</em> tested by the <code>TRY-CAS</code> operation. Looking at <code>FREE(C)</code> again:</p>
<pre><code>1: do
2:     current = *F
3:     C.next = current;
4: while !TRY-CAS(F, current, C)
</code></pre>
<p>We need to consider <code>C</code> and <code>current</code>. We can very reasonably make the assumption that the calling program is well-behaved, and will never use the cell <code>C</code> again after passing it to <code>FREE(C)</code> (unless it obtains it again in the future through another call to <code>ALLOCATE</code>, which cannot happen until <code>FREE</code> has inserted it into the free list). Therefore, <code>C</code> cannot be changed in any way other than the code in <code>FREE</code> changes it. The <code>FREE</code> operation holds the sole reference to <code>C</code> at this point.</p>
<p>Life is much more complicated for <code>current</code>. It is possible for a preemption at line 3 of <code>FREE</code>, followed by another thread allocating the cell pointed to by <code>current</code> and then freeing it again, which <em>is</em> certainly a case of an ABA state change. However, unlike the situation we saw in <code>ALLOCATE</code>, the <code>FREE</code> operation does not depend on the content of <code>current</code>. We can see this by noticing how it never looks inside of it, and instead just holds a reference to it. An operation cannot depend upon a value it never accesses. Therefore, <code>FREE</code> is not vulnerable to the ABA problem.</p>
<div id="atatags-370373-6027b8c565810">
        <script type="text/javascript">
            __ATA.cmd.push(function() {
                __ATA.initVideoSlot('atatags-370373-6027b8c565810', {
                    sectionId: '370373',
                    format: 'inread'
                });
            });
        </script>
    </div>			<div id="atatags-26942-6027b8c565866"></div>
			
			<script>
				__ATA.cmd.push(function() {
					__ATA.initDynamicSlot({
						id: 'atatags-26942-6027b8c565866',
						location: 120,
						formFactor: '001',
						label: {
							text: 'Advertisements',
						},
						creative: {
							reportAd: {
								text: 'Report this ad',
							},
							privacySettings: {
								text: 'Privacy',
								
							}
						}
					});
				});
			</script><div id="jp-post-flair" class="sharedaddy sd-like-enabled sd-sharing-enabled"><div class="sharedaddy sd-sharing-enabled"><div class="robots-nocontent sd-block sd-social sd-social-icon-text sd-sharing"><h3 class="sd-title">Share this:</h3><div class="sd-content"><ul><li class="share-twitter"><a rel="nofollow noopener noreferrer" data-shared="sharing-twitter-476" class="share-twitter sd-button share-icon" href="https://6guts.wordpress.com/2017/04/22/massively-reducing-moarvm-fixed-size-allocator-contention/?share=twitter" target="_blank" title="Click to share on Twitter"><span>Twitter</span></a></li><li class="share-facebook"><a rel="nofollow noopener noreferrer" data-shared="sharing-facebook-476" class="share-facebook sd-button share-icon" href="https://6guts.wordpress.com/2017/04/22/massively-reducing-moarvm-fixed-size-allocator-contention/?share=facebook" target="_blank" title="Click to share on Facebook"><span>Facebook</span></a></li><li class="share-end"></li></ul></div></div></div><div class='sharedaddy sd-block sd-like jetpack-likes-widget-wrapper jetpack-likes-widget-unloaded' id='like-post-wrapper-14597269-476-6027b8c565dcc' data-src='//widgets.wp.com/likes/index.html?ver=20200826#blog_id=14597269&amp;post_id=476&amp;origin=6guts.wordpress.com&amp;obj_id=14597269-476-6027b8c565dcc' data-name='like-post-frame-14597269-476-6027b8c565dcc'><h3 class='sd-title'>Like this:</h3><div class='likes-widget-placeholder post-likes-widget-placeholder' style='height: 55px;'><span class='button'><span>Like</span></span> <span class="loading">Loading...</span></div><span class='sd-text-color'></span><a class='sd-link-color'></a></div>
<div id='jp-relatedposts' class='jp-relatedposts' >
	<h3 class="jp-relatedposts-headline"><em>Related</em></h3>
</div></div>											</div><!-- .entry-content -->

		
						<div class="entry-utility">
							This entry was posted in <a href="https://6guts.wordpress.com/category/uncategorized/" rel="category tag">Uncategorized</a>. Bookmark the <a href="https://6guts.wordpress.com/2017/04/22/massively-reducing-moarvm-fixed-size-allocator-contention/" title="Permalink to Massively reducing MoarVM Fixed Size Allocator&nbsp;contention" rel="bookmark">permalink</a>.													</div><!-- .entry-utility -->
					</div><!-- #post-476 -->

				<div id="nav-below" class="navigation">
					<div class="nav-previous"><a href="https://6guts.wordpress.com/2017/03/16/considering-hyperrace-semantics/" rel="prev"><span class="meta-nav">&larr;</span> Considering hyper/race semantics</a></div>
					<div class="nav-next"><a href="https://6guts.wordpress.com/2017/05/12/looking-for-perl-6-rakudo-and-moarvm-development-funding/" rel="next">Looking for Perl 6, Rakudo, and MoarVM development&nbsp;funding <span class="meta-nav">&rarr;</span></a></div>
				</div><!-- #nav-below -->

				
			<div id="comments">


			<h3 id="comments-title">
			3 Responses to <em>Massively reducing MoarVM Fixed Size Allocator&nbsp;contention</em>			</h3>


			<ol class="commentlist">
						<li class="comment even thread-even depth-1 highlander-comment" id="li-comment-2956">
		<div id="comment-2956">
			<div class="comment-author vcard">
				<img alt='' src='https://2.gravatar.com/avatar/e4421a84d860b084828386686aedc649?s=40&#038;d=identicon&#038;r=G' class='avatar avatar-40' height='40' width='40' />				<cite class="fn">Paul Marquess</cite> <span class="says">says:</span>			</div><!-- .comment-author .vcard -->

				
				
			<div class="comment-meta commentmetadata"><a href="https://6guts.wordpress.com/2017/04/22/massively-reducing-moarvm-fixed-size-allocator-contention/#comment-2956">
				April 23, 2017 at 7:31 PM</a>			</div><!-- .comment-meta .commentmetadata -->

			<div class="comment-body"><p>This reminds me about a change mode at $WORK to a massively parallel event driven process (single process, multiple threads) which may (or may not) be relevant here. The application initially had it&#8217;s own chunk allocator to deal with the issues around malloc bottlenecks. Lots of carefully written code that was tuned to how the application worked under the hood, but it still needed a &#8220;malloc&#8221; implementation behind the scenes. For a long time we used tcmalloc. Over time we&#8217;ve tried a few malloc alternatives. Current top-of-the-heap is jemalloc. The very latest change made was to completely remove the applications own allocation code and just let jemalloc get on with it. Don&#8217;t have the performance improvements to hand, but it did give a significant performance boost. </p>
<p>Obviously it &#8220;horses for courses&#8221; when it comes to memory allocation, but were any of the well know malloc libraries given a try to see if they were fit for purpose?</p>
</div>

			<div class="reply">
				<a rel='nofollow' class='comment-reply-link' href='https://6guts.wordpress.com/2017/04/22/massively-reducing-moarvm-fixed-size-allocator-contention/?replytocom=2956#respond' data-commentid="2956" data-postid="476" data-belowelement="comment-2956" data-respondelement="respond" data-replyto="Reply to Paul Marquess" aria-label='Reply to Paul Marquess'>Reply</a>			</div><!-- .reply -->
		</div><!-- #comment-##  -->

				<ul class="children">
		<li class="comment byuser comment-author-jnthnwrthngtn bypostauthor odd alt depth-2 highlander-comment" id="li-comment-2957">
		<div id="comment-2957">
			<div class="comment-author vcard">
				<img alt='' src='https://2.gravatar.com/avatar/5999d5d26089eb4019867dc7705c41a9?s=40&#038;d=identicon&#038;r=G' class='avatar avatar-40' height='40' width='40' />				<cite class="fn"><a href='https://6guts.wordpress.com' rel='external nofollow ugc' class='url'>jnthnwrthngtn</a></cite> <span class="says">says:</span>			</div><!-- .comment-author .vcard -->

				
				
			<div class="comment-meta commentmetadata"><a href="https://6guts.wordpress.com/2017/04/22/massively-reducing-moarvm-fixed-size-allocator-contention/#comment-2957">
				April 23, 2017 at 9:25 PM</a>			</div><!-- .comment-meta .commentmetadata -->

			<div class="comment-body"><p>It&#8217;s a good point. I&#8217;ve briefly looked at some of the malloc alternatives in the past, but usually didn&#8217;t make it past one of licensing or platform support. Glancing the two you mentioned, tcmalloc notes it is only minimally supported on Windows, which is a major target platform for MoarVM. And jemalloc looks better in terms of support, but the build process for it involves Cygwin, which would be an incredible irony to require for building MoarVM because Cygwin is one of the things do *not* we support (because libuv doesn&#8217;t work there due to missing async I/O support). Of course, there would be ways to keep an easy source build on Windows and use jemalloc (like ship a ready-built DLL), so it&#8217;s a plausible option, though figuring this stuff out increases the cost of adopting it. (To be clear, easy source builds are something I consider really important for keeping the barrier to contribution low.)</p>
<p>We did stick all of our `malloc`/`calloc`/`free` calls behind static inline functions to enable us to try out such things, and there&#8217;s also a way to make the fixed size allocator just use malloc/free instead, so as to enable us to experiment and benchmark alternatives malloc implementations on a range of workloads. It just hasn&#8217;t really happened yet. A possible complication is that the fixed size allocator also has a &#8220;free at safepoint&#8221; mechanism (used in implementing various data structures in MoarVM that may always be read lock free and only need a lock on update), which is going to be something VM-specific, so we couldn&#8217;t throw out that aspect of it. The rest, in principle, could go away in favor of a better malloc library.</p>
</div>

			<div class="reply">
				<a rel='nofollow' class='comment-reply-link' href='https://6guts.wordpress.com/2017/04/22/massively-reducing-moarvm-fixed-size-allocator-contention/?replytocom=2957#respond' data-commentid="2957" data-postid="476" data-belowelement="comment-2957" data-respondelement="respond" data-replyto="Reply to jnthnwrthngtn" aria-label='Reply to jnthnwrthngtn'>Reply</a>			</div><!-- .reply -->
		</div><!-- #comment-##  -->

				</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
		<li class="post pingback">
		<p>Pingback: <a href='https://p6weekly.wordpress.com/2017/04/24/2017-17-interesting-times/' rel='external nofollow ugc' class='url'>2017.17 Interesting Times | Weekly changes in and around Perl 6</a></p>
				</li><!-- #comment-## -->
			</ol>


	

	<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="/2017/04/22/massively-reducing-moarvm-fixed-size-allocator-contention/#respond" style="display:none;">Cancel reply</a></small></h3><form action="https://6guts.wordpress.com/wp-comments-post.php" method="post" id="commentform" class="comment-form"><input type="hidden" id="highlander_comment_nonce" name="highlander_comment_nonce" value="d7e6913b3a" /><input type="hidden" name="_wp_http_referer" value="/2017/04/22/massively-reducing-moarvm-fixed-size-allocator-contention/" />
<input type="hidden" name="hc_post_as" id="hc_post_as" value="guest" />

<div class="comment-form-field comment-textarea">
	<label for="comment">Enter your comment here...</label>
	<div id="comment-form-comment"><textarea id="comment" name="comment" title="Enter your comment here..."></textarea></div>
</div>

<div id="comment-form-identity">
	<div id="comment-form-nascar">
		<p>Fill in your details below or click an icon to log in:</p>
		<ul>
			<li class="selected" style="display:none;">
				<a href="#comment-form-guest" id="postas-guest" class="nascar-signin-link"
                   title="Login via Guest">
									</a>
			</li>
			<li>
				<a href="#comment-form-load-service:WordPress.com" id="postas-wordpress" class="nascar-signin-link"
                   title="Login via WordPress.com">
					<svg xmlns="http://www.w3.org/2000/svg" role="presentation" viewBox="0 0 24 24" ><rect x="0" fill="none" width="24" height="24"/><g><path fill="#0087be" d="M12.158 12.786l-2.698 7.84c.806.236 1.657.365 2.54.365 1.047 0 2.05-.18 2.986-.51-.024-.037-.046-.078-.065-.123l-2.762-7.57zM3.008 12c0 3.56 2.07 6.634 5.068 8.092L3.788 8.342c-.5 1.117-.78 2.354-.78 3.658zm15.06-.454c0-1.112-.398-1.88-.74-2.48-.456-.74-.883-1.368-.883-2.11 0-.825.627-1.595 1.51-1.595.04 0 .078.006.116.008-1.598-1.464-3.73-2.36-6.07-2.36-3.14 0-5.904 1.613-7.512 4.053.21.008.41.012.58.012.94 0 2.395-.114 2.395-.114.484-.028.54.684.057.74 0 0-.487.058-1.03.086l3.275 9.74 1.968-5.902-1.4-3.838c-.485-.028-.944-.085-.944-.085-.486-.03-.43-.77.056-.742 0 0 1.484.114 2.368.114.94 0 2.397-.114 2.397-.114.486-.028.543.684.058.74 0 0-.488.058-1.03.086l3.25 9.665.897-2.997c.456-1.17.684-2.137.684-2.907zm1.82-3.86c.04.286.06.593.06.924 0 .912-.17 1.938-.683 3.22l-2.746 7.94c2.672-1.558 4.47-4.454 4.47-7.77 0-1.564-.4-3.033-1.1-4.314zM12 22C6.486 22 2 17.514 2 12S6.486 2 12 2s10 4.486 10 10-4.486 10-10 10z"/></g></svg>				</a>
			</li>
			<li>
			<iframe id="googleplus-sign-in" name="googleplus-sign-in" src="https://public-api.wordpress.com/connect/?googleplus-sign-in=https%3A%2F%2F6guts.wordpress.com&#038;color_scheme=light" width="24" height="24" scrolling="no" allowtransparency="true" seamless="seamless" frameborder="0"></iframe>
			</li>
			<li>
				<a href="#comment-form-load-service:Twitter" id="postas-twitter" class="nascar-signin-link"
                   title="Login via Twitter">
					<svg xmlns="http://www.w3.org/2000/svg" role="presentation" viewBox="0 0 24 24" ><rect x="0" fill="none" width="24" height="24"/><g><path fill="#1DA1F2" d="M22.23 5.924c-.736.326-1.527.547-2.357.646.847-.508 1.498-1.312 1.804-2.27-.793.47-1.67.812-2.606.996C18.325 4.498 17.258 4 16.078 4c-2.266 0-4.103 1.837-4.103 4.103 0 .322.036.635.106.935-3.41-.17-6.433-1.804-8.457-4.287-.353.607-.556 1.312-.556 2.064 0 1.424.724 2.68 1.825 3.415-.673-.022-1.305-.207-1.86-.514v.052c0 1.988 1.415 3.647 3.293 4.023-.344.095-.707.145-1.08.145-.265 0-.522-.026-.773-.074.522 1.63 2.038 2.817 3.833 2.85-1.404 1.1-3.174 1.757-5.096 1.757-.332 0-.66-.02-.98-.057 1.816 1.164 3.973 1.843 6.29 1.843 7.547 0 11.675-6.252 11.675-11.675 0-.178-.004-.355-.012-.53.802-.578 1.497-1.3 2.047-2.124z"/></g></svg>				</a>
			</li>
			<li>
				<a href="#comment-form-load-service:Facebook" id="postas-facebook" class="nascar-signin-link"
                   title="Login via Facebook">
					<svg xmlns="http://www.w3.org/2000/svg" role="presentation" viewBox="0 0 24 24" ><rect x="0" fill="none" width="24" height="24"/><g><path fill="#3B5998" d="M20.007 3H3.993C3.445 3 3 3.445 3 3.993v16.013c0 .55.445.994.993.994h8.62v-6.97H10.27V11.31h2.346V9.31c0-2.325 1.42-3.59 3.494-3.59.993 0 1.847.073 2.096.106v2.43h-1.438c-1.128 0-1.346.537-1.346 1.324v1.734h2.69l-.35 2.717h-2.34V21h4.587c.548 0 .993-.445.993-.993V3.993c0-.548-.445-.993-.993-.993z"/></g></svg>				</a>
			</li>
		</ul>
	</div>

	<div id="comment-form-guest" class="comment-form-service selected">
		<div class="comment-form-padder">
			<div class="comment-form-avatar">
<a href="https://gravatar.com/site/signup/" target="_blank">				<img src="https://1.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=25&amp;d=identicon&amp;forcedefault=y&amp;r=G" alt="Gravatar" width="25" class="no-grav" />
</a>			</div>

				<div class="comment-form-fields">
				<div class="comment-form-field comment-form-email">
					<label for="email">Email <span class="required">(required)</span> <span class="nopublish">(Address never made public)</span></label>
					<div class="comment-form-input"><input id="email" name="email" type="email" value="" /></div>
				</div>
				<div class="comment-form-field comment-form-author">
					<label for="author">Name <span class="required">(required)</span></label>
					<div class="comment-form-input"><input id="author" name="author" type="text" value="" /></div>
				</div>
				<div class="comment-form-field comment-form-url">
					<label for="url">Website</label>
					<div class="comment-form-input"><input id="url" name="url" type="url" value="" /></div>
				</div>
			</div>
			
		</div>
	</div>

	<div id="comment-form-wordpress" class="comment-form-service">
		<div class="comment-form-padder">
			<div class="comment-form-avatar">
				<img src="https://1.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=25&amp;d=identicon&amp;forcedefault=y&amp;r=G" alt="WordPress.com Logo" width="25" class="no-grav" />
			</div>

				<div class="comment-form-fields">
				<input type="hidden" name="wp_avatar" id="wordpress-avatar" class="comment-meta-wordpress" value="" />
				<input type="hidden" name="wp_user_id" id="wordpress-user_id" class="comment-meta-wordpress" value="" />
				<input type="hidden" name="wp_access_token" id="wordpress-access_token" class="comment-meta-wordpress" value="" />
						<p class="comment-form-posting-as pa-wordpress">
			<strong></strong>
			You are commenting using your WordPress.com account.			<span class="comment-form-log-out">
				(&nbsp;<a href="javascript:HighlanderComments.doExternalLogout( 'wordpress' );">Log&nbsp;Out</a>&nbsp;/&nbsp;
				<a href="#" onclick="javascript:HighlanderComments.switchAccount();return false;">Change</a>&nbsp;)
			</span>
			<span class="pa-icon"><svg xmlns="http://www.w3.org/2000/svg" role="presentation" viewBox="0 0 24 24" ><rect x="0" fill="none" width="24" height="24"/><g><path fill="#0087be" d="M12.158 12.786l-2.698 7.84c.806.236 1.657.365 2.54.365 1.047 0 2.05-.18 2.986-.51-.024-.037-.046-.078-.065-.123l-2.762-7.57zM3.008 12c0 3.56 2.07 6.634 5.068 8.092L3.788 8.342c-.5 1.117-.78 2.354-.78 3.658zm15.06-.454c0-1.112-.398-1.88-.74-2.48-.456-.74-.883-1.368-.883-2.11 0-.825.627-1.595 1.51-1.595.04 0 .078.006.116.008-1.598-1.464-3.73-2.36-6.07-2.36-3.14 0-5.904 1.613-7.512 4.053.21.008.41.012.58.012.94 0 2.395-.114 2.395-.114.484-.028.54.684.057.74 0 0-.487.058-1.03.086l3.275 9.74 1.968-5.902-1.4-3.838c-.485-.028-.944-.085-.944-.085-.486-.03-.43-.77.056-.742 0 0 1.484.114 2.368.114.94 0 2.397-.114 2.397-.114.486-.028.543.684.058.74 0 0-.488.058-1.03.086l3.25 9.665.897-2.997c.456-1.17.684-2.137.684-2.907zm1.82-3.86c.04.286.06.593.06.924 0 .912-.17 1.938-.683 3.22l-2.746 7.94c2.672-1.558 4.47-4.454 4.47-7.77 0-1.564-.4-3.033-1.1-4.314zM12 22C6.486 22 2 17.514 2 12S6.486 2 12 2s10 4.486 10 10-4.486 10-10 10z"/></g></svg></span>
		</p>
					</div>
	
		</div>
	</div>

	<div id="comment-form-googleplus" class="comment-form-service">
		<div class="comment-form-padder">
			<div class="comment-form-avatar">
				<img src="https://1.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=25&amp;d=identicon&amp;forcedefault=y&amp;r=G" alt="Google photo" width="25" class="no-grav" />
			</div>

				<div class="comment-form-fields">
				<input type="hidden" name="googleplus_avatar" id="googleplus-avatar" class="comment-meta-googleplus" value="" />
				<input type="hidden" name="googleplus_user_id" id="googleplus-user_id" class="comment-meta-googleplus" value="" />
				<input type="hidden" name="googleplus_access_token" id="googleplus-access_token" class="comment-meta-googleplus" value="" />
						<p class="comment-form-posting-as pa-googleplus">
			<strong></strong>
			You are commenting using your Google account.			<span class="comment-form-log-out">
				(&nbsp;<a href="javascript:HighlanderComments.doExternalLogout( 'googleplus' );">Log&nbsp;Out</a>&nbsp;/&nbsp;
				<a href="#" onclick="javascript:HighlanderComments.switchAccount();return false;">Change</a>&nbsp;)
			</span>
			<span class="pa-icon"><svg xmlns="http://www.w3.org/2000/svg" role="presentation" x="0px" y="0px" viewBox="0 0 60 60" ><path fill="#519bf7" d="M56.3,30c0,-1.6 -0.2,-3.4 -0.6,-5h-3.1H42.2H30v10.6h14.8C44,39.3 42,42 39.1,43.9l8.8,6.8C53,46 56.3,39 56.3,30z" /><path fill="#3db366" d="M30,57.5c6.7,0 13.1,-2.4 17.9,-6.8l-8.8,-6.8c-2.5,1.6 -5.6,2.4 -9.1,2.4c-7.2,0 -13.3,-4.7 -15.4,-11.2l-9.3,7.1C9.8,51.3 19.1,57.5 30,57.5z" /><path fill="#fdc600" d="M5.3,42.2l9.3,-7.1c-0.5,-1.6 -0.8,-3.3 -0.8,-5.1s0.3,-3.5 0.8,-5.1l-9.3,-7.1C3.5,21.5 2.5,25.6 2.5,30S3.5,38.5 5.3,42.2z" /><path fill="#f15b44" d="M40.1,17.4l8,-8C43.3,5.1 37,2.5 30,2.5C19.1,2.5 9.8,8.7 5.3,17.8l9.3,7.1c2.1,-6.5 8.2,-11.1 15.4,-11.1C33.9,13.7 37.4,15.1 40.1,17.4z" /></svg></span>
		</p>
					</div>
	
		</div>
	</div>

	<div id="comment-form-twitter" class="comment-form-service">
		<div class="comment-form-padder">
			<div class="comment-form-avatar">
				<img src="https://1.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=25&amp;d=identicon&amp;forcedefault=y&amp;r=G" alt="Twitter picture" width="25" class="no-grav" />
			</div>

				<div class="comment-form-fields">
				<input type="hidden" name="twitter_avatar" id="twitter-avatar" class="comment-meta-twitter" value="" />
				<input type="hidden" name="twitter_user_id" id="twitter-user_id" class="comment-meta-twitter" value="" />
				<input type="hidden" name="twitter_access_token" id="twitter-access_token" class="comment-meta-twitter" value="" />
						<p class="comment-form-posting-as pa-twitter">
			<strong></strong>
			You are commenting using your Twitter account.			<span class="comment-form-log-out">
				(&nbsp;<a href="javascript:HighlanderComments.doExternalLogout( 'twitter' );">Log&nbsp;Out</a>&nbsp;/&nbsp;
				<a href="#" onclick="javascript:HighlanderComments.switchAccount();return false;">Change</a>&nbsp;)
			</span>
			<span class="pa-icon"><svg xmlns="http://www.w3.org/2000/svg" role="presentation" viewBox="0 0 24 24" ><rect x="0" fill="none" width="24" height="24"/><g><path fill="#1DA1F2" d="M22.23 5.924c-.736.326-1.527.547-2.357.646.847-.508 1.498-1.312 1.804-2.27-.793.47-1.67.812-2.606.996C18.325 4.498 17.258 4 16.078 4c-2.266 0-4.103 1.837-4.103 4.103 0 .322.036.635.106.935-3.41-.17-6.433-1.804-8.457-4.287-.353.607-.556 1.312-.556 2.064 0 1.424.724 2.68 1.825 3.415-.673-.022-1.305-.207-1.86-.514v.052c0 1.988 1.415 3.647 3.293 4.023-.344.095-.707.145-1.08.145-.265 0-.522-.026-.773-.074.522 1.63 2.038 2.817 3.833 2.85-1.404 1.1-3.174 1.757-5.096 1.757-.332 0-.66-.02-.98-.057 1.816 1.164 3.973 1.843 6.29 1.843 7.547 0 11.675-6.252 11.675-11.675 0-.178-.004-.355-.012-.53.802-.578 1.497-1.3 2.047-2.124z"/></g></svg></span>
		</p>
					</div>
	
		</div>
	</div>

	<div id="comment-form-facebook" class="comment-form-service">
		<div class="comment-form-padder">
			<div class="comment-form-avatar">
				<img src="https://1.gravatar.com/avatar/ad516503a11cd5ca435acc9bb6523536?s=25&amp;d=identicon&amp;forcedefault=y&amp;r=G" alt="Facebook photo" width="25" class="no-grav" />
			</div>

				<div class="comment-form-fields">
				<input type="hidden" name="fb_avatar" id="facebook-avatar" class="comment-meta-facebook" value="" />
				<input type="hidden" name="fb_user_id" id="facebook-user_id" class="comment-meta-facebook" value="" />
				<input type="hidden" name="fb_access_token" id="facebook-access_token" class="comment-meta-facebook" value="" />
						<p class="comment-form-posting-as pa-facebook">
			<strong></strong>
			You are commenting using your Facebook account.			<span class="comment-form-log-out">
				(&nbsp;<a href="javascript:HighlanderComments.doExternalLogout( 'facebook' );">Log&nbsp;Out</a>&nbsp;/&nbsp;
				<a href="#" onclick="javascript:HighlanderComments.switchAccount();return false;">Change</a>&nbsp;)
			</span>
			<span class="pa-icon"><svg xmlns="http://www.w3.org/2000/svg" role="presentation" viewBox="0 0 24 24" ><rect x="0" fill="none" width="24" height="24"/><g><path fill="#3B5998" d="M20.007 3H3.993C3.445 3 3 3.445 3 3.993v16.013c0 .55.445.994.993.994h8.62v-6.97H10.27V11.31h2.346V9.31c0-2.325 1.42-3.59 3.494-3.59.993 0 1.847.073 2.096.106v2.43h-1.438c-1.128 0-1.346.537-1.346 1.324v1.734h2.69l-.35 2.717h-2.34V21h4.587c.548 0 .993-.445.993-.993V3.993c0-.548-.445-.993-.993-.993z"/></g></svg></span>
		</p>
					</div>
	
		</div>
	</div>


	<div id="comment-form-load-service" class="comment-form-service">
		<div class="comment-form-posting-as-cancel"><a href="javascript:HighlanderComments.cancelExternalWindow();">Cancel</a></div>
		<p>Connecting to %s</p>
	</div>

</div>

<script type="text/javascript">
var highlander_expando_javascript = function () {

	function hide( sel ) {
		var el = document.querySelector( sel );
		if ( el ) {
			el.style.setProperty( 'display', 'none' );
		}
	}

	function show( sel ) {
		var el = document.querySelector( sel );
		if ( el ) {
			el.style.removeProperty( 'display' );
		}
	}

	var input = document.createElement( 'input' );
	var comment = document.querySelector( '#comment' );

	if ( input && comment && 'placeholder' in input ) {
		var label = document.querySelector( '.comment-textarea label' );
		if ( label ) {
			var text = label.textContent;
			label.parentNode.removeChild( label );
			comment.setAttribute( 'placeholder', text );
		}
	}

	// Expando Mode: start small, then auto-resize on first click + text length
	hide( '#comment-form-identity' );
	hide( '#comment-form-subscribe' );
	hide( '#commentform .form-submit' );

	if ( comment ) {
		comment.style.height = '10px';

		var handler = function () {
			comment.style.height = HighlanderComments.initialHeight + 'px';
			show( '#comment-form-identity' );
			show( '#comment-form-subscribe' );
			show( '#commentform .form-submit' );
			HighlanderComments.resizeCallback();

			comment.removeEventListener( 'focus', handler );
		};

		comment.addEventListener( 'focus', handler );
	}
}

if ( document.readyState !== 'loading' ) {
	highlander_expando_javascript();
} else {
	if ( typeof window.jQuery === 'function' ) {
		// Use jQuery's `ready` if available.
		// This solves some scheduling issues between this script and the main highlander script.
		jQuery( document ).ready( highlander_expando_javascript );
	} else {
		// If not available, add a vanilla event listener.
		document.addEventListener( 'DOMContentLoaded', highlander_expando_javascript );
	}
}

</script>

<div id="comment-form-subscribe">
	<p class="comment-subscription-form"><input type="checkbox" name="subscribe" id="subscribe" value="subscribe" style="width: auto;"/> <label class="subscribe-label" id="subscribe-label" for="subscribe" style="display: inline;">Notify me of new comments via email.</label></p><p class="post-subscription-form"><input type="checkbox" name="subscribe_blog" id="subscribe_blog" value="subscribe" style="width: auto;"/> <label class="subscribe-label" id="subscribe-blog-label" for="subscribe_blog"  style="display: inline;">Notify me of new posts via email.</label></p></div>




<p class="form-submit"><input name="submit" type="submit" id="comment-submit" class="submit" value="Post Comment" /> <input type='hidden' name='comment_post_ID' value='476' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p><p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="a61e9f3214" /></p>
<input type="hidden" name="genseq" value="1613215941" />
<input type="hidden" id="ak_js" name="ak_js" value="34"/><textarea name="ak_hp_textarea" cols="45" rows="8" maxlength="100" style="display: none !important;"></textarea></form>	</div><!-- #respond -->
	<div style="clear: both"></div><p class="akismet_comment_form_privacy_notice">This site uses Akismet to reduce spam. <a href="https://akismet.com/privacy/" target="_blank" rel="nofollow noopener">Learn how your comment data is processed</a>.</p>
</div><!-- #comments -->

	
			</div><!-- #content -->
		</div><!-- #container -->


		<div id="primary" class="widget-area" role="complementary">
						<ul class="xoxo">

<li id="search-2" class="widget-container widget_search"><form role="search" method="get" id="searchform" class="searchform" action="https://6guts.wordpress.com/">
				<div>
					<label class="screen-reader-text" for="s">Search for:</label>
					<input type="text" value="" name="s" id="s" />
					<input type="submit" id="searchsubmit" value="Search" />
				</div>
			</form></li>
		<li id="recent-posts-2" class="widget-container widget_recent_entries">
		<h3 class="widget-title">Recent Posts</h3>
		<ul>
											<li>
					<a href="https://6guts.wordpress.com/2020/10/05/taking-a-break-from-raku-core-development/">Taking a break from Raku core&nbsp;development</a>
									</li>
											<li>
					<a href="https://6guts.wordpress.com/2019/01/02/my-perl-6-wishes-for-2019/">My Perl 6 wishes for&nbsp;2019</a>
									</li>
											<li>
					<a href="https://6guts.wordpress.com/2018/10/06/speeding-up-object-creation/">Speeding up object&nbsp;creation</a>
									</li>
											<li>
					<a href="https://6guts.wordpress.com/2018/09/29/eliminating-unrequired-guards/">Eliminating unrequired guards</a>
									</li>
											<li>
					<a href="https://6guts.wordpress.com/2018/09/28/faster-box-unbox-and-int-operations/">Faster box/unbox and Int&nbsp;operations</a>
									</li>
					</ul>

		</li><li id="recent-comments-2" class="widget-container widget_recent_comments"><h3 class="widget-title">Recent Comments</h3>				<table class="recentcommentsavatar" cellspacing="0" cellpadding="0" border="0">
					<tr><td title="2019.01 Wishes for 2019 | Weekly changes in and around Perl 6" class="recentcommentsavatartop" style="height:48px; width:48px;"><a href="https://p6weekly.wordpress.com/2019/01/08/2019-01-wishes-for-2019/" rel="nofollow"></a></td><td class="recentcommentstexttop" style=""><a href="https://p6weekly.wordpress.com/2019/01/08/2019-01-wishes-for-2019/" rel="nofollow">2019.01 Wishes for 2&hellip;</a> on <a href="https://6guts.wordpress.com/2019/01/02/my-perl-6-wishes-for-2019/#comment-6005">My Perl 6 wishes for&nbsp;2019</a></td></tr><tr><td title="hobbified (@hobbified)" class="recentcommentsavatarend" style="height:48px; width:48px;"><a href="http://twitter.com/hobbified" rel="nofollow"><img alt='' src='https://i1.wp.com/pbs.twimg.com/profile_images/67477518/dr_haas_normal.jpg?resize=48%2C48' class='avatar avatar-48' height='48' width='48' /></a></td><td class="recentcommentstextend" style=""><a href="http://twitter.com/hobbified" rel="nofollow">hobbified (@hobbifie&hellip;</a> on <a href="https://6guts.wordpress.com/2018/10/06/speeding-up-object-creation/#comment-5966">Speeding up object&nbsp;creati&hellip;</a></td></tr><tr><td title="Alex" class="recentcommentsavatarend" style="height:48px; width:48px;"><a href="http://gravatar.com/kaokun" rel="nofollow"><img alt='' src='https://0.gravatar.com/avatar/6428904bea03ecf54d864d2bf574a3a2?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /></a></td><td class="recentcommentstextend" style=""><a href="http://gravatar.com/kaokun" rel="nofollow">Alex</a> on <a href="https://6guts.wordpress.com/2018/10/06/speeding-up-object-creation/#comment-5913">Speeding up object&nbsp;creati&hellip;</a></td></tr><tr><td title="jnthnwrthngtn" class="recentcommentsavatarend" style="height:48px; width:48px;"><a href="https://6guts.wordpress.com" rel="nofollow"><img alt='' src='https://2.gravatar.com/avatar/5999d5d26089eb4019867dc7705c41a9?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /></a></td><td class="recentcommentstextend" style=""><a href="https://6guts.wordpress.com" rel="nofollow">jnthnwrthngtn</a> on <a href="https://6guts.wordpress.com/2018/10/06/speeding-up-object-creation/#comment-5907">Speeding up object&nbsp;creati&hellip;</a></td></tr><tr><td title="Alex" class="recentcommentsavatarend" style="height:48px; width:48px;"><img alt='' src='https://0.gravatar.com/avatar/6428904bea03ecf54d864d2bf574a3a2?s=48&#038;d=identicon&#038;r=G' class='avatar avatar-48' height='48' width='48' /></td><td class="recentcommentstextend" style="">Alex on <a href="https://6guts.wordpress.com/2018/10/06/speeding-up-object-creation/#comment-5896">Speeding up object&nbsp;creati&hellip;</a></td></tr>				</table>
				</li><li id="archives-2" class="widget-container widget_archive"><h3 class="widget-title">Archives</h3>
			<ul>
					<li><a href='https://6guts.wordpress.com/2020/10/'>October 2020</a></li>
	<li><a href='https://6guts.wordpress.com/2019/01/'>January 2019</a></li>
	<li><a href='https://6guts.wordpress.com/2018/10/'>October 2018</a></li>
	<li><a href='https://6guts.wordpress.com/2018/09/'>September 2018</a></li>
	<li><a href='https://6guts.wordpress.com/2018/07/'>July 2018</a></li>
	<li><a href='https://6guts.wordpress.com/2018/06/'>June 2018</a></li>
	<li><a href='https://6guts.wordpress.com/2018/03/'>March 2018</a></li>
	<li><a href='https://6guts.wordpress.com/2018/01/'>January 2018</a></li>
	<li><a href='https://6guts.wordpress.com/2017/11/'>November 2017</a></li>
	<li><a href='https://6guts.wordpress.com/2017/09/'>September 2017</a></li>
	<li><a href='https://6guts.wordpress.com/2017/08/'>August 2017</a></li>
	<li><a href='https://6guts.wordpress.com/2017/07/'>July 2017</a></li>
	<li><a href='https://6guts.wordpress.com/2017/06/'>June 2017</a></li>
	<li><a href='https://6guts.wordpress.com/2017/05/'>May 2017</a></li>
	<li><a href='https://6guts.wordpress.com/2017/04/'>April 2017</a></li>
	<li><a href='https://6guts.wordpress.com/2017/03/'>March 2017</a></li>
	<li><a href='https://6guts.wordpress.com/2016/12/'>December 2016</a></li>
	<li><a href='https://6guts.wordpress.com/2016/11/'>November 2016</a></li>
	<li><a href='https://6guts.wordpress.com/2016/08/'>August 2016</a></li>
	<li><a href='https://6guts.wordpress.com/2016/07/'>July 2016</a></li>
	<li><a href='https://6guts.wordpress.com/2016/06/'>June 2016</a></li>
	<li><a href='https://6guts.wordpress.com/2016/04/'>April 2016</a></li>
	<li><a href='https://6guts.wordpress.com/2016/03/'>March 2016</a></li>
	<li><a href='https://6guts.wordpress.com/2016/02/'>February 2016</a></li>
	<li><a href='https://6guts.wordpress.com/2016/01/'>January 2016</a></li>
	<li><a href='https://6guts.wordpress.com/2015/12/'>December 2015</a></li>
	<li><a href='https://6guts.wordpress.com/2015/11/'>November 2015</a></li>
	<li><a href='https://6guts.wordpress.com/2015/10/'>October 2015</a></li>
	<li><a href='https://6guts.wordpress.com/2015/09/'>September 2015</a></li>
	<li><a href='https://6guts.wordpress.com/2015/08/'>August 2015</a></li>
	<li><a href='https://6guts.wordpress.com/2015/07/'>July 2015</a></li>
	<li><a href='https://6guts.wordpress.com/2015/06/'>June 2015</a></li>
	<li><a href='https://6guts.wordpress.com/2015/05/'>May 2015</a></li>
	<li><a href='https://6guts.wordpress.com/2015/04/'>April 2015</a></li>
	<li><a href='https://6guts.wordpress.com/2014/06/'>June 2014</a></li>
	<li><a href='https://6guts.wordpress.com/2014/04/'>April 2014</a></li>
	<li><a href='https://6guts.wordpress.com/2014/01/'>January 2014</a></li>
	<li><a href='https://6guts.wordpress.com/2013/12/'>December 2013</a></li>
	<li><a href='https://6guts.wordpress.com/2013/10/'>October 2013</a></li>
	<li><a href='https://6guts.wordpress.com/2013/09/'>September 2013</a></li>
	<li><a href='https://6guts.wordpress.com/2013/08/'>August 2013</a></li>
	<li><a href='https://6guts.wordpress.com/2013/07/'>July 2013</a></li>
	<li><a href='https://6guts.wordpress.com/2013/05/'>May 2013</a></li>
	<li><a href='https://6guts.wordpress.com/2013/04/'>April 2013</a></li>
	<li><a href='https://6guts.wordpress.com/2013/02/'>February 2013</a></li>
	<li><a href='https://6guts.wordpress.com/2013/01/'>January 2013</a></li>
	<li><a href='https://6guts.wordpress.com/2012/11/'>November 2012</a></li>
	<li><a href='https://6guts.wordpress.com/2012/10/'>October 2012</a></li>
	<li><a href='https://6guts.wordpress.com/2012/09/'>September 2012</a></li>
	<li><a href='https://6guts.wordpress.com/2012/08/'>August 2012</a></li>
	<li><a href='https://6guts.wordpress.com/2012/07/'>July 2012</a></li>
	<li><a href='https://6guts.wordpress.com/2012/06/'>June 2012</a></li>
	<li><a href='https://6guts.wordpress.com/2012/05/'>May 2012</a></li>
	<li><a href='https://6guts.wordpress.com/2012/04/'>April 2012</a></li>
	<li><a href='https://6guts.wordpress.com/2012/03/'>March 2012</a></li>
	<li><a href='https://6guts.wordpress.com/2012/02/'>February 2012</a></li>
	<li><a href='https://6guts.wordpress.com/2012/01/'>January 2012</a></li>
	<li><a href='https://6guts.wordpress.com/2011/11/'>November 2011</a></li>
	<li><a href='https://6guts.wordpress.com/2011/10/'>October 2011</a></li>
	<li><a href='https://6guts.wordpress.com/2011/09/'>September 2011</a></li>
	<li><a href='https://6guts.wordpress.com/2011/08/'>August 2011</a></li>
	<li><a href='https://6guts.wordpress.com/2011/07/'>July 2011</a></li>
	<li><a href='https://6guts.wordpress.com/2011/06/'>June 2011</a></li>
	<li><a href='https://6guts.wordpress.com/2011/05/'>May 2011</a></li>
	<li><a href='https://6guts.wordpress.com/2011/04/'>April 2011</a></li>
	<li><a href='https://6guts.wordpress.com/2011/02/'>February 2011</a></li>
	<li><a href='https://6guts.wordpress.com/2011/01/'>January 2011</a></li>
	<li><a href='https://6guts.wordpress.com/2010/11/'>November 2010</a></li>
	<li><a href='https://6guts.wordpress.com/2010/10/'>October 2010</a></li>
	<li><a href='https://6guts.wordpress.com/2010/09/'>September 2010</a></li>
	<li><a href='https://6guts.wordpress.com/2010/08/'>August 2010</a></li>
	<li><a href='https://6guts.wordpress.com/2010/07/'>July 2010</a></li>
			</ul>

			</li><li id="categories-2" class="widget-container widget_categories"><h3 class="widget-title">Categories</h3>
			<ul>
					<li class="cat-item cat-item-1"><a href="https://6guts.wordpress.com/category/uncategorized/">Uncategorized</a>
</li>
			</ul>

			</li><li id="meta-2" class="widget-container widget_meta"><h3 class="widget-title">Meta</h3>
		<ul>
			<li><a href="https://wordpress.com/start?ref=wplogin">Register</a></li>			<li><a href="https://6guts.wordpress.com/wp-login.php">Log in</a></li>
			<li><a href="https://6guts.wordpress.com/feed/">Entries feed</a></li>
			<li><a href="https://6guts.wordpress.com/comments/feed/">Comments feed</a></li>

			<li><a href="https://wordpress.com/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress.com</a></li>
		</ul>

		</li>			<div id="atatags-286348-6027b8c56e4ed"></div>
			
			<script>
				__ATA.cmd.push(function() {
					__ATA.initDynamicSlot({
						id: 'atatags-286348-6027b8c56e4ed',
						location: 140,
						formFactor: '003',
						label: {
							text: 'Advertisements',
						},
						creative: {
							reportAd: {
								text: 'Report this ad',
							},
							privacySettings: {
								text: 'Privacy',
								
							}
						}
					});
				});
			</script>			</ul>
		</div><!-- #primary .widget-area -->

	</div><!-- #main -->

	<div id="footer" role="contentinfo">
		<div id="colophon">



			<div id="site-info">
				<a href="https://6guts.wordpress.com/" title="6guts" rel="home">
					6guts				</a>
							</div><!-- #site-info -->

			<div id="site-generator">
								<a href="https://wordpress.com/?ref=footer_blog" rel="nofollow">Blog at WordPress.com.</a>
			</div><!-- #site-generator -->

		</div><!-- #colophon -->
	</div><!-- #footer -->

</div><!-- #wrapper -->

<!--  -->
<script src='//0.gravatar.com/js/gprofiles.js?ver=202106y' id='grofiles-cards-js'></script>
<script id='wpgroho-js-extra'>
var WPGroHo = {"my_hash":""};
</script>
<script type='text/javascript' src='https://s0.wp.com/wp-content/mu-plugins/gravatar-hovercards/wpgroho.js?m=1610363240h'></script>

	<script>
		// Initialize and attach hovercards to all gravatars
		( function() {
			function init() {
				if ( typeof Gravatar === 'undefined' ) {
					return;
				}

				if ( typeof Gravatar.init !== 'function' ) {
					return;
				}

				Gravatar.profile_cb = function ( hash, id ) {
					WPGroHo.syncProfileData( hash, id );
				};

				Gravatar.my_hash = WPGroHo.my_hash;
				Gravatar.init( 'body', '#wp-admin-bar-my-account' );
			}

			if ( document.readyState !== 'loading' ) {
				init();
			} else {
				document.addEventListener( 'DOMContentLoaded', init );
			}
		} )();
	</script>

		<div style="display:none">
	<div class="grofile-hash-map-e4421a84d860b084828386686aedc649">
	</div>
	<div class="grofile-hash-map-5999d5d26089eb4019867dc7705c41a9">
	</div>
	<div class="grofile-hash-map-5147bc9a113fad891146efe41b79f2d6">
	</div>
	<div class="grofile-hash-map-6428904bea03ecf54d864d2bf574a3a2">
	</div>
	</div>
<script id='highlander-comments-js-extra'>
var HighlanderComments = {"loggingInText":"Logging In\u2026","submittingText":"Posting Comment\u2026","postCommentText":"Post Comment","connectingToText":"Connecting to %s","commentingAsText":"%1$s: You are commenting using your %2$s account.","logoutText":"Log Out","loginText":"Log In","connectURL":"https:\/\/6guts.wordpress.com\/public.api\/connect\/?action=request","logoutURL":"https:\/\/6guts.wordpress.com\/wp-login.php?action=logout&_wpnonce=c0076cd1eb","homeURL":"https:\/\/6guts.wordpress.com\/","postID":"476","gravDefault":"identicon","enterACommentError":"Please enter a comment","enterEmailError":"Please enter your email address here","invalidEmailError":"Invalid email address","enterAuthorError":"Please enter your name here","gravatarFromEmail":"This picture will show whenever you leave a comment. Click to customize it.","logInToExternalAccount":"Log in to use details from one of these accounts.","change":"Change","changeAccount":"Change Account","comment_registration":"","userIsLoggedIn":"","isJetpack":"","text_direction":"ltr"};
</script>
<script type='text/javascript' src='https://s0.wp.com/_static/??/wp-content/js/jquery/jquery.autoresize.js,/wp-content/mu-plugins/highlander-comments/script.js?m=1573483029j'></script>
		<!-- CCPA [start] -->
		<script type="text/javascript">
			( function () {

				var setupPrivacy = function() {

					document.addEventListener( 'DOMContentLoaded', function() {

						// Minimal Mozilla Cookie library
						// https://developer.mozilla.org/en-US/docs/Web/API/Document/cookie/Simple_document.cookie_framework
						var cookieLib = window.cookieLib = {getItem:function(e){return e&&decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(e,o,n,t,r,i){if(!e||/^(?:expires|max\-age|path|domain|secure)$/i.test(e))return!1;var c="";if(n)switch(n.constructor){case Number:c=n===1/0?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+n;break;case String:c="; expires="+n;break;case Date:c="; expires="+n.toUTCString()}return"rootDomain"!==r&&".rootDomain"!==r||(r=(".rootDomain"===r?".":"")+document.location.hostname.split(".").slice(-2).join(".")),document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(o)+c+(r?"; domain="+r:"")+(t?"; path="+t:"")+(i?"; secure":""),!0}};

						var setDefaultOptInCookie = function() {
							var value = '1YNN';
							var domain = '.wordpress.com' === location.hostname.slice( -14 ) ? '.rootDomain' : location.hostname;
							cookieLib.setItem( 'usprivacy', value, 365 * 24 * 60 * 60, '/', domain );
						};

						var setCcpaAppliesCookie = function( value ) {
							var domain = '.wordpress.com' === location.hostname.slice( -14 ) ? '.rootDomain' : location.hostname;
							cookieLib.setItem( 'ccpa_applies', value, 24 * 60 * 60, '/', domain );
						}

						var maybeCallDoNotSellCallback = function() {
							if ( 'function' === typeof window.doNotSellCallback ) {
								return window.doNotSellCallback();
							}

							return false;
						}

						var usprivacyCookie = cookieLib.getItem( 'usprivacy' );

						if ( null !== usprivacyCookie ) {
							maybeCallDoNotSellCallback();
							return;
						}

						var ccpaCookie = cookieLib.getItem( 'ccpa_applies' );

						if ( null === ccpaCookie ) {

							var request = new XMLHttpRequest();
							request.open( 'GET', 'https://public-api.wordpress.com/geo/', true );

							request.onreadystatechange = function () {
								if ( 4 === this.readyState ) {
									if ( 200 === this.status ) {

										var data = JSON.parse( this.response );
										var ccpa_applies = data['region'] && data['region'].toLowerCase() === 'california';

										setCcpaAppliesCookie( ccpa_applies );

										if ( ccpa_applies ) {
											if ( maybeCallDoNotSellCallback() ) {
												setDefaultOptInCookie();
											}
										}
									} else {
										setCcpaAppliesCookie( true );
										if ( maybeCallDoNotSellCallback() ) {
											setDefaultOptInCookie();
										}
									}
								}
							};

							request.send();
						} else {
							if ( ccpaCookie === 'true' ) {
								if ( maybeCallDoNotSellCallback() ) {
									setDefaultOptInCookie();
								}
							}
						}
					} );
				};

				if ( window.defQueue && defQueue.isLOHP && defQueue.isLOHP === 2020 ) {
					defQueue.items.push( setupPrivacy );
				} else {
					setupPrivacy();
				}

			} )();
		</script>

		<!-- CCPA [end] -->
					<script type="text/javascript">
			( function( $ ) {
				$( document.body ).on( 'post-load', function () {
					if ( typeof __ATA.insertInlineAds === 'function' ) {
						__ATA.insertInlineAds();
					}
				} );
			} )( jQuery );
			</script>
<script>
window.addEventListener( "load", function( event ) {
	var link = document.createElement( "link" );
	link.href = "https://s0.wp.com/wp-content/mu-plugins/actionbar/actionbar.css?v=20201002";
	link.type = "text/css";
	link.rel = "stylesheet";
	document.head.appendChild( link );

	var script = document.createElement( "script" );
	script.src = "https://s0.wp.com/wp-content/mu-plugins/actionbar/actionbar.js?v=20201002";
	script.defer = true;
	document.body.appendChild( script );
} );
</script>

	
	<script type="text/javascript">
		window.WPCOM_sharing_counts = {"https:\/\/6guts.wordpress.com\/2017\/04\/22\/massively-reducing-moarvm-fixed-size-allocator-contention\/":476};
	</script>
				<div class="widget widget_eu_cookie_law_widget">
<div
	class="hide-on-button ads-active"
	data-hide-timeout="30"
	data-consent-expiration="180"
	id="eu-cookie-law"
>
	<form method="post">
		<input type="submit" value="Close and accept" class="accept" />

		Privacy &amp; Cookies: This site uses cookies. By continuing to use this website, you agree to their use. <br />
To find out more, including how to control cookies, see here:
				<a href="https://automattic.com/cookies" rel="nofollow">
			Cookie Policy		</a>
 </form>
</div>
</div><script id='sharing-js-js-extra'>
var sharing_js_options = {"lang":"en","counts":"1","is_stats_active":"1"};
</script>
<script type='text/javascript' src='https://s0.wp.com/_static/??-eJyFkN1OwzAMhV+I1BQQgwvEoyCTeJ3TJM1iZ2U8PUZiF/yoXNnyOeezbFir80tRKgpRINCJPdW3IcoVfJfqIppJBCf6Q43HTu38VQYuJ6b1X1skrehn10j4/Rc1d1dTn7gIJJ5JwEKdDlhConYxc/GpBxMN7pecLWi4ms5D5rJBXDlMpALUTV1mJpdwBaVcEyr9mG9wMNge94oNMopSs85ps6NkKzSzZFJ3O1zDi10A+6XlDf/n690+ITeQAzYu06Va6Dk/jffjzfi4e7jbxQ8TLqzD'></script>
<script type='text/javascript'>
var windowOpen;
			( function () {
				function matches( el, sel ) {
					return !! (
						el.matches && el.matches( sel ) ||
						el.msMatchesSelector && el.msMatchesSelector( sel )
					);
				}

				document.body.addEventListener( 'click', function ( event ) {
					if ( ! event.target ) {
						return;
					}

					var el;
					if ( matches( event.target, 'a.share-twitter' ) ) {
						el = event.target;
					} else if ( event.target.parentNode && matches( event.target.parentNode, 'a.share-twitter' ) ) {
						el = event.target.parentNode;
					}

					if ( el ) {
						event.preventDefault();

						// If there's another sharing window open, close it.
						if ( typeof windowOpen !== 'undefined' ) {
							windowOpen.close();
						}
						windowOpen = window.open( el.getAttribute( 'href' ), 'wpcomtwitter', 'menubar=1,resizable=1,width=600,height=350' );
						return false;
					}
				} );
			} )();
var windowOpen;
			( function () {
				function matches( el, sel ) {
					return !! (
						el.matches && el.matches( sel ) ||
						el.msMatchesSelector && el.msMatchesSelector( sel )
					);
				}

				document.body.addEventListener( 'click', function ( event ) {
					if ( ! event.target ) {
						return;
					}

					var el;
					if ( matches( event.target, 'a.share-facebook' ) ) {
						el = event.target;
					} else if ( event.target.parentNode && matches( event.target.parentNode, 'a.share-facebook' ) ) {
						el = event.target.parentNode;
					}

					if ( el ) {
						event.preventDefault();

						// If there's another sharing window open, close it.
						if ( typeof windowOpen !== 'undefined' ) {
							windowOpen.close();
						}
						windowOpen = window.open( el.getAttribute( 'href' ), 'wpcomfacebook', 'menubar=1,resizable=1,width=600,height=400' );
						return false;
					}
				} );
			} )();
</script>
<script type="text/javascript">
// <![CDATA[
(function() {
try{
  if ( window.external &&'msIsSiteMode' in window.external) {
    if (window.external.msIsSiteMode()) {
      var jl = document.createElement('script');
      jl.type='text/javascript';
      jl.async=true;
      jl.src='/wp-content/plugins/ie-sitemode/custom-jumplist.php';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(jl, s);
    }
  }
}catch(e){}
})();
// ]]>
</script>		<iframe src='https://widgets.wp.com/likes/master.html?ver=20200826#ver=20200826' scrolling='no' id='likes-master' name='likes-master' style='display:none;'></iframe>
		<div id='likes-other-gravatars'><div class="likes-text"><span>%d</span> bloggers like this:</div><ul class="wpl-avatars sd-like-gravatars"></ul></div>
<script src="//stats.wp.com/w.js?61" defer></script> <script type="text/javascript">
_tkq = window._tkq || [];
_stq = window._stq || [];
_tkq.push(['storeContext', {'blog_id':'14597269','blog_tz':'1','user_lang':'en','blog_lang':'en','user_id':'0'}]);
_stq.push(['view', {'blog':'14597269','v':'wpcom','tz':'1','user_id':'0','post':'476','subd':'6guts'}]);
_stq.push(['extra', {'crypt':'UE5XaGUuOTlwaD85flAmcm1mcmZsaDhkV11YdWFnNncxc1tjZG9XVXhRY2gzcWhIRkllQ2l2Q3ZyRGZSdDFEZVhvNj1rNTdSdGl1aEhCQ3pnWlEmMnVtTXlIUlJbRStpdFg3SzUwS19ncCU9d216SXhPRUNTJTdKcWtBTVloUktfVjREOWlfPVMlTzNQVFk4QjV6YX5aNzBDQm1xSD1Yb08lVGtxUH49YVJkM35nJXhQMExNRHE4ejgvJnVSJU9xVXZqfGx6WlJMRU5GQVZtZHxiM1kwY2JsfFI/cG80SDNzflNMNnJoakldTC9tNCZxRSZtXzBZdktsMkQseFA5Rkw4bC9aWVZqJlNJW1R1MUIsTjdnWC1rU1RNVQ=='}]);
_stq.push([ 'clickTrackerInit', '14597269', '476' ]);
	</script>
<noscript><img src="https://pixel.wp.com/b.gif?v=noscript" style="height:1px;width:1px;overflow:hidden;position:absolute;bottom:1px;" alt="" /></noscript>
<script>
if ( 'object' === typeof wpcom_mobile_user_agent_info ) {

	wpcom_mobile_user_agent_info.init();
	var mobileStatsQueryString = "";
	
	if( false !== wpcom_mobile_user_agent_info.matchedPlatformName )
		mobileStatsQueryString += "&x_" + 'mobile_platforms' + '=' + wpcom_mobile_user_agent_info.matchedPlatformName;
	
	if( false !== wpcom_mobile_user_agent_info.matchedUserAgentName )
		mobileStatsQueryString += "&x_" + 'mobile_devices' + '=' + wpcom_mobile_user_agent_info.matchedUserAgentName;
	
	if( wpcom_mobile_user_agent_info.isIPad() )
		mobileStatsQueryString += "&x_" + 'ipad_views' + '=' + 'views';

	if( "" != mobileStatsQueryString ) {
		new Image().src = document.location.protocol + '//pixel.wp.com/g.gif?v=wpcom-no-pv' + mobileStatsQueryString + '&baba=' + Math.random();
	}
	
}
</script></body>
</html>
